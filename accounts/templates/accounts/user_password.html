{% extends 'base.html' %}

{% block title %}Cambiar contraseña - {{ user.username }}{% endblock %}

{% block content %}
<main class="main-content">
    <header class="content__header content__header--flex">
        <h1 class="content__title">
            <i class="fas fa-key"></i> Cambiar contraseña
            <small>para {{ user.username }}</small>
        </h1>
        <a href="{% url 'user_list' %}" class="btn btn--primary btn--icon">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </header>

    <hr class="divider">

    <form method="post" class="form">
        {% csrf_token %}
        
        <div class="form-grid">
            <div class="form-group">
                <label for="{{ form.old_password.id_for_label }}" class="form-label">
                    <i class="fas fa-lock"></i> {{ form.old_password.label }}
                </label>
                {{ form.old_password }}
                {% if form.old_password.errors %}
                    <div class="form-error">
                        <i class="fas fa-exclamation-circle"></i> {{ form.old_password.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                    <i class="fas fa-key"></i> {{ form.new_password1.label }}
                </label>
                {{ form.new_password1 }}
                <div class="form-help-text">
                    {{ form.new_password1.help_text }}
                </div>
                {% if form.new_password1.errors %}
                    <div class="form-error">
                        <i class="fas fa-exclamation-circle"></i> {{ form.new_password1.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                    <i class="fas fa-key"></i> {{ form.new_password2.label }}
                </label>
                {{ form.new_password2 }}
                {% if form.new_password2.errors %}
                    <div class="form-error">
                        <i class="fas fa-exclamation-circle"></i> {{ form.new_password2.errors }}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Medidor de fortaleza de contraseña -->
        <div class="form-section">
            <h3 class="form-section__title">
                <i class="fas fa-shield-alt"></i> Fortaleza de la contraseña
            </h3>
            <div class="password-strength">
                <div class="strength-meter">
                    <div class="strength-bar" id="strength-bar" data-score="0"></div>
                </div>
                <div class="strength-labels">
                    <span data-score="0">Débil</span>
                    <span data-score="1">Regular</span>
                    <span data-score="2">Buena</span>
                    <span data-score="3">Fuerte</span>
                    <span data-score="4">Muy fuerte</span>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary btn--lg btn--icon">
                <i class="fas fa-save"></i> Actualizar contraseña
            </button>
            <a href="{% url 'user_list' %}" class="btn btn--danger btn--lg btn--icon">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthBar = document.getElementById('strength-bar');
    const strengthLabels = document.querySelectorAll('.strength-labels span');
    
    if (passwordInput && strengthBar) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            // Actualizar la barra de fortaleza
            strengthBar.style.width = ['20%', '40%', '60%', '80%', '100%'][strength.score];
            strengthBar.setAttribute('data-score', strength.score);
            
            // Actualizar etiquetas
            strengthLabels.forEach((label, index) => {
                if (index <= strength.score) {
                    label.style.color = getStrengthColor(strength.score);
                    label.style.fontWeight = '600';
                } else {
                    label.style.color = '';
                    label.style.fontWeight = '';
                }
            });
        });
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        
        // Longitud mínima
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        
        // Contiene números
        if (/\d/.test(password)) score++;
        
        // Contiene mayúsculas y minúsculas
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        
        // Contiene caracteres especiales
        if (/[^a-zA-Z0-9]/.test(password)) score++;
        
        // Ajustar el score máximo a 4
        return {
            score: Math.min(score, 4),
            status: ['Débil', 'Regular', 'Buena', 'Fuerte', 'Muy fuerte'][Math.min(score, 4)]
        };
    }
    
    function getStrengthColor(score) {
        const colors = [
            'var(--error-color)',    // 0 - Débil
            '#f39c12',               // 1 - Regular
            '#f1c40f',               // 2 - Buena
            'var(--success-color)',  // 3 - Fuerte
            '#27ae60'                // 4 - Muy fuerte
        ];
        return colors[score] || colors[0];
    }
});
</script>
{% endblock %}