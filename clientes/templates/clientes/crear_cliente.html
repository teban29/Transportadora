{% extends 'base.html' %}

{% load static %}
{% block title %}Crear cliente{% endblock %}
{% block content %}

<main class="main-content">
    <header class="content__header content__header--flex">
        <h1 class="content__title">Crear cliente</h1>
        <div>
            <a href="{% url 'clientes' %}" class="btn btn--primary btn--icon">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </header>

    <hr class="divider">

    <form method="post" class="form">
        {% csrf_token %}
        
        <!-- Campos del formulario en dos columnas -->
        <div class="form-grid">
            <div class="form-group">
                <label for="{{ form.nit.id_for_label }}">{{ form.nit.label }}</label>
                {{ form.nit }}
                {% if form.nit.errors %}
                    <div class="form-error">{{ form.nit.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
                {{ form.nombre }}
                {% if form.nombre.errors %}
                    <div class="form-error">{{ form.nombre.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="form-error">{{ form.email.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.telefono.id_for_label }}">{{ form.telefono.label }}</label>
                {{ form.telefono }}
                {% if form.telefono.errors %}
                    <div class="form-error">{{ form.telefono.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.ciudad.id_for_label }}">{{ form.ciudad.label }}</label>
                {{ form.ciudad }}
                {% if form.ciudad.errors %}
                    <div class="form-error">{{ form.ciudad.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.direccion.id_for_label }}">{{ form.direccion.label }}</label>
                {{ form.direccion }}
                {% if form.direccion.errors %}
                    <div class="form-error">{{ form.direccion.errors }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Campo de selección de proveedores -->
        <div class="form-section">
            <h3 class="form-section__title">Proveedores asociados</h3>
            <div id="proveedores-container" class="form-section__content">
                <div class="proveedor-form card">
                    <div class="form-group">
                        <label>Proveedor</label>
                        <select name="proveedores[]" class="form-select proveedor-select" required>
                            <option value="" disabled selected>Seleccione un proveedor</option>
                            {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn btn--danger btn--sm eliminar-proveedor">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </div>
            </div>
            <button type="button" id="añadir-proveedor" class="btn btn--success btn--icon">
                <i class="fas fa-plus"></i> Añadir Proveedor
            </button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary btn--lg">
                <i class="fas fa-save"></i> Crear Cliente
            </button>
            <a href="{% url 'clientes' %}" class="btn btn--danger btn--lg">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const proveedoresContainer = document.getElementById('proveedores-container');
        const añadirProveedorButton = document.getElementById('añadir-proveedor');
        
        // Función para actualizar las opciones de los selectores
        function actualizarOpciones() {
            const selects = document.querySelectorAll('.proveedor-select');
            const proveedoresSeleccionados = new Set();

            // Obtener todos los proveedores seleccionados
            selects.forEach(select => {
                if (select.value) {
                    proveedoresSeleccionados.add(select.value);
                }
            });

            // Actualizar las opciones de cada selector
            selects.forEach(select => {
                Array.from(select.options).forEach(option => {
                    if (option.value && proveedoresSeleccionados.has(option.value)) {
                        option.style.display = 'none';  // Ocultar proveedores ya seleccionados
                    } else {
                        option.style.display = 'block';  // Mostrar proveedores disponibles
                    }
                });
            });
        }

        // Función para añadir un nuevo campo de proveedor
        añadirProveedorButton.addEventListener('click', function() {
            const nuevoProveedor = document.querySelector('.proveedor-form').cloneNode(true);
            nuevoProveedor.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;  // Limpiar selección
                select.addEventListener('change', actualizarOpciones);  // Actualizar opciones al cambiar
            });
            proveedoresContainer.appendChild(nuevoProveedor);
            actualizarOpciones();  // Actualizar opciones después de agregar un nuevo campo
        });
        
        // Función para eliminar un campo de proveedor
        proveedoresContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('eliminar-proveedor') || 
                event.target.closest('.eliminar-proveedor')) {
                const btn = event.target.classList.contains('eliminar-proveedor') ? 
                    event.target : event.target.closest('.eliminar-proveedor');
                btn.parentElement.remove();
                actualizarOpciones();  // Actualizar opciones después de eliminar un campo
            }
        });

        // Inicializar eventos de cambio en los selectores existentes
        document.querySelectorAll('.proveedor-select').forEach(select => {
            select.addEventListener('change', actualizarOpciones);
        });
    });
</script>

{% endblock %}